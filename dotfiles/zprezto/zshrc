#
# Executes commands at the start of an interactive session.
#
# Authors:
#   Sorin Ionescu <sorin.ionescu@gmail.com>
#

# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# Customize to your needs...

# Get the current OS name
case $(uname) in
  Darwin) os=mac ;;
  Linux) os=linux ;;
  *) exit 1 ;;
esac

# Incremental history search with peco
# Refs: https://qiita.com/shepabashi/items/f2bc2be37a31df49bca5
function peco-history-selection() {
  case $os in
    mac) BUFFER=$(history -n 1 | tail -r | awk '!a[$0]++' | peco) ;;
    linux) BUFFER=$(history -n 1 | tac | awk '!a[$0]++' | peco) ;;
  esac

  CURSOR=$#BUFFER
  zle reset-prompt
}

zle -N peco-history-selection
bindkey '^R' peco-history-selection

# Suppress brew doctor warning caused by asdf python
# Refs: https://zenn.dev/ryuu/scraps/fddefc2ca60f88
# case $os in
  # Intel
  # mac) alias brew="PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin brew" ;;
# esac

# direnv
eval "$(direnv hook zsh)"

# For `$ rails app:update`
export THOR_MERGE="code -d $1 $2"

export PATH=${HOME}/bin:${PATH}

# GPG
export GPG_TTY=$(tty)

# OS specific settings

# Mac
if [ "$os" = "mac" ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)" # Apple silicon
  # PostgreSQL
  export PATH="/opt/homebrew/opt/postgresql@15/bin:${PATH}"
  export LDFLAGS="-L/opt/homebrew/opt/postgresql@15/lib"
  export CPPFLAGS="-I/opt/homebrew/opt/postgresql@15/include"
  # export PATH="/usr/local/opt/openssl/bin:$PATH"
fi

# Linux
if [ "$os" = "linux" ]; then
  # Path settings

  # VS Code
  win_user_path=$(wslpath "$(wslvar USERPROFILE)")
  export PATH=$PATH:"$win_user_path/AppData/Local/Programs/Microsoft VS Code/bin"

  # Homebrew
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

  # SSH
  /usr/bin/keychain -q --nogui "$HOME"/.ssh/id_ed25519
  source "$HOME"/.keychain/"$HOST"-sh
fi

# asdf
case $os in
  mac) . /opt/homebrew/opt/asdf/libexec/asdf.sh ;; # Apple silicon
  # mac) . /usr/local/opt/asdf/libexec/asdf.sh ;; # Intel
  linux) . /home/linuxbrew/.linuxbrew/opt/asdf/libexec/asdf.sh ;;
esac

# ESP-IDF

# ESP-IDF v4.4.6 を使わないときはアンコメント。使うときはコメントアウト
asdf global python 3.12.1

# ESP-IDF v4.4.6 を使わないときはコメントアウト。使うときはアンコメント

## ESP-IDFインストール前にアンコメント開始

# asdf global python 3.11.7
# export IDF_PATH=${HOME}/esp/esp-idf
# export IDF_TOOLS_PATH=${HOME}/.espressif

## ESP-IDFインストール後にアンコメント開始

# alias get_idf='. $HOME/esp/esp-idf/export.sh'
# export IDF_PYTHON_ENV_PATH=${HOME}/.espressif/python_env/idf4.4_py3.11_env

# ESP-IDF v5.1.2 を使わないときはコメントアウト。使うときはアンコメント

## ESP-IDFインストール前にアンコメント開始

# export IDF_PATH=${HOME}/esp5/esp-idf
# export IDF_TOOLS_PATH=${HOME}/.espressif5

## ESP-IDFインストール後にアンコメント開始

# alias get_idf='. $HOME/esp5/esp-idf/export.sh'
# export IDF_PYTHON_ENV_PATH=${HOME}/.espressif5/python_env/idf5.1_py3.12_env

# ESP-IDF を使わないときはコメントアウト。使うときはアンコメント

## ESP-IDFインストール後にアンコメント開始

# export PATH=${IDF_PYTHON_ENV_PATH}/bin:${PATH}
